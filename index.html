<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=0.5, maximum-scale=2.0, user-scalable=yes" />
    <title></title>
    <style type="text/css">
        .s{
            color: rgb(100,100,100);
        }
    </style>
    <script src="Astar.js"></script>
</head>
<body onload="initGame()">
<div>
  <canvas id="snake" width="1200" height="510" style="margin-left: auto;margin-right: auto"></canvas>
    <div style="width:600px;margin-left: auto;margin-right: auto"><input type="button" value="AI模式" onclick="AIRun()">
        <input type="button" value="开始游戏" onclick="startGame()">
        <input type="button" value="暂停游戏" onclick="pauseGame()">
        <input type="button" value="重新开始" onclick="restartGame()"></div>
    <div><span id="testmsg"></span></div>
    <div><span id="testmsg2"></span></div>
    <div><span id="testmsg3"></span></div>
</div>
    <script>

        var width = 500;
        var height = 500;
        var bgColor = "#ACD6FF";
        var lineColor = "#FFFFFF";
        var snackColor = "green";
        var foodColor = "red";
        var init_X = 350;
        var init_Y = 5;
        var space =25;
        var X_num = width / space;
        var Y_num = height /space;
        var snakeBody_X = [9,10,11,12];
        var snakeBody_Y = [10,10,10,10];
        var food_X = 3;
        var food_Y = 3;
        var direction  = 1;
        var thread;
        var msg = "";

        var snackCanvas = document.getElementById("snake");
        var ctx = snackCanvas.getContext("2d");
        ctx.translate(init_X,init_Y);


        function drawBgColor(){
            ctx.fillStyle = bgColor;
            ctx.fillRect(0,0,width,height);
        }

        function drawBgLine(){
            ctx.strokeStyle = lineColor;
            for(var i = 0; i <= Math.floor(width/space); i++ ){
                ctx.beginPath();
                ctx.moveTo(space*i,0);
                ctx.lineTo(space*i,height);
                ctx.closePath();
                ctx.stroke();
            }
            for(var i = 0; i <= Math.floor(height/space); i++ ){
                ctx.beginPath();
                ctx.moveTo(0,space*i);
                ctx.lineTo(width,space*i);
                ctx.closePath();
                ctx.stroke();
            }
        }

        function drawSnack(){
            ctx.fillStyle = "red";
            ctx.beginPath();
            ctx.arc(snakeBody_X[0]*space+space/2,snakeBody_Y[0]*space+space/2,space/2,0,Math.PI*2,true);
            ctx.closePath();
            ctx.fill();
            ctx.fillStyle = "blue";
            for(var i = 1;i<snakeBody_X.length;i++){
                ctx.fillRect(snakeBody_X[i]*space,snakeBody_Y[i]*space,space,space);
            }
        }

        function drawFood(){

            var color = '#'+('00000'+(Math.random()*0x1000000<<0).toString(16)).slice(-6);
            ctx.fillStyle = color;
            //ctx.fillStyle = "yellow";
            ctx.fillRect(food_X*space,food_Y*space,space,space);

            var color = '#'+('00000'+(Math.random()*0x1000000<<0).toString(16)).slice(-6);
            ctx.fillStyle = color;
            ctx.beginPath();
            ctx.arc(food_X*space+space/2,food_Y*space+space/2,space/2,0,Math.PI*2);


            ctx.closePath();
            ctx.fill();
        }

        function drawBlock() {
            for(var i=0;i<map.length;i++) {
                for(var j=0;j<map[0].length;j++) {
                    if(map[i][j] == 2) {
                        ctx.fillStyle = "black";
                        ctx.fillRect(i*space,j*space,space,space);
                    }
                }
            }
        }

        function addHead(head_X,head_Y){
            snakeBody_X.splice(0,0,head_X);
            snakeBody_Y.splice(0,0,head_Y);
        }

        function removeTail(){
            snakeBody_X.pop();
            snakeBody_Y.pop();
        }

        function move(){
            var head_X;
            var head_Y;

            switch (direction){
                case 1:
                    head_X = snakeBody_X[0]-1;
                    if(head_X < 0)
                        head_X = X_num-1;
                    head_Y = snakeBody_Y[0];
                    break;
                case 2:
                    head_X = snakeBody_X[0];
                    head_Y = snakeBody_Y[0]-1;
                    if(head_Y < 0)
                        head_Y = Y_num-1;
                    break;
                case 3:
                    head_X = snakeBody_X[0] + 1;
                    if(head_X >= X_num)
                        head_X = 0;
                    head_Y = snakeBody_Y[0];
                    break;
                case 4:
                    head_X = snakeBody_X[0];
                    head_Y = snakeBody_Y[0]+1;
                    if(head_Y >= Y_num)
                        head_Y = 0;
                    break;

            }
            if(isEatFood(head_X,head_Y)){
                addHead(head_X,head_Y);
            }else{
                addHead(head_X,head_Y);
                removeTail();
            }

        }

    function changeDirection(data){
        switch (data){
            case 37:
                if(direction != 3)
                    direction = 1;
                break;
            case 38:
                if(direction != 4)
                    direction = 2;
                break;
            case 39:
                if(direction != 1)
                    direction = 3;
                break;
            case 40:
                if(direction != 2)
                    direction = 4;
                break;
        }
    }

        function changeDirection2(event){
            event = event || window.event;
            switch (event.keyCode){
                case 37:
                    if(direction != 3)
                        direction = 1;
                    break;
                case 38:
                    if(direction != 4)
                        direction = 2;
                    break;
                case 39:
                    if(direction != 1)
                        direction = 3;
                    break;
                case 40:
                    if(direction != 2)
                        direction = 4;
                    break;
            }
        }

        function isEatFood(head_X,head_Y){
            if (food_X == head_X && food_Y == head_Y){
                createFood();
                return true;
            }else{
                return false;
            }

        }

        function createFood(){
            food_X = Math.floor(Math.random()*X_num);
            food_Y = Math.floor(Math.random()*Y_num);
            for(var i=0;i<snakeBody_X.length;i++) {
                if(food_X == snakeBody_X[i] && food_Y == snakeBody_Y[i]) {
                    createFood();
                    break;
                }
            }
        }

        function isEatSelf() {
            for(var i = 1; i < snakeBody_X.length; i++){
                if(snakeBody_X[0] == snakeBody_X[i] && snakeBody_Y[0] == snakeBody_Y[i]){
                    msg = "吃到自己，游戏结束!";
                    clearInterval(thread);
                    return true;
                }
            }
            return false;
        }

        function isOutOfBounds(){
            if(snakeBody_X[0] < 0 || snakeBody_X[0] > X_num-1 ||
               snakeBody_Y[0] < 0 || snakeBody_Y[0] > Y_num-1){
                msg = "出界，游戏结束!";
                clearInterval(thread);
                return true;
            }
            return false;
        }

        function run(){
            ctx.clearRect(-200,-5,width+210,height+100);
            drawBgColor();
            drawSnack();
           // aStarRun();
            move();
            isEatSelf();
            //isOutOfBounds();

            drawSnack();
            drawFood();
            drawBlock();

            drawBoard();
            drawBgLine();
        }

        function Arun() {
            ctx.clearRect(-200,-5,width+210,height+100);
            drawBgColor();
            drawSnack();
            aStarRun();
            move();
            isEatSelf();
            //isOutOfBounds();

            drawSnack();
            drawFood();
            drawBlock();

            drawBoard();
            drawBgLine();
        }

        var map = [];
        for(var i=0;i<X_num;i++) {
            map[i] = [];
            for(var j=0;j<Y_num;j++) {
                map[i][j] = 0;
            }
        }

    function resetMap() {
        for(var i=0;i<X_num;i++) {
            map[i] = [];
            for(var j=0;j<Y_num;j++) {
                map[i][j] = 0;
            }
        }

        for(var i=0;i<snakeBody_X.length;i++) {
            map[snakeBody_X[i]][snakeBody_Y[i]] = 1;
        }
    }
        function draw() {
            for(var i=0;i<snakeBody_X.length;i++) {
                map[snakeBody_X[i]][snakeBody_Y[i]] = 1;
            }
            for(var i=0;i<map.length;i++) {
                for(var j=0;j<map[0].length;j++) {
                    if(map[i][j] == 0) {
                        ctx.fillStyle = "#ACD6FF";
                    }else if(map[i][j] == 1) {
                        ctx.fillStyle = "blue";
                    }
                    ctx.fillRect(i*space,j*space,space,space);
                }
            }


        }

        function aStarRun() {
            resetMap();
            var resultList = search1(snakeBody_X[0],snakeBody_Y[0],food_X,food_Y);

            var nowX = snakeBody_X[0];
            var nowY = snakeBody_Y[0];
            if(resultList.length == 1) {
                //move();
            }
            if(resultList.length > 1) {
                var nextX = resultList[1].getX();
                var nextY = resultList[1].getY();

                if(nowX - nextX == 1) {
                    direction = 1;
                }else if(nowX - nextX == -1) {
                    direction = 3;
                }else if(nowY - nextY == 1) {
                    direction = 2;
                }else if(nowY - nextY == -1) {
                    direction = 4;
                }
            }
        }


        function initGame(){
            drawBgColor();
            drawFood();
            drawSnack();
            drawBlock();
            drawBgLine();
            drawBoard();
        }

        function startGame(){
            thread =setInterval(run,100);
            document.onkeydown = changeDirection2;
        }

        function AIRun() {
            thread =setInterval(Arun,50);
            document.onkeydown = changeDirection2;
        }

        function pauseGame(){
            clearInterval(thread);
        }

        function restartGame(){
            snakeBody_X = [16,17,18,19];
            snakeBody_Y = [10,10,10,10];
            food_X = 5;
            food_Y = 10;
            direction  = 1;
            msg = "";
            initGame();
            thread = setInterval(run,200);
        }

        function drawBoard(){
            ctx.fillStyle="lightblue";
            ctx.fillRect(width+5,0,200,500);
            ctx.fillStyle="red";
            ctx.font="25px 宋体";
            ctx.fillText(msg,width+10,50,190);
            ctx.fillText("当前长度："+snakeBody_X.length,width+10,150,190);
        }

    </script>
</body>
</html>
